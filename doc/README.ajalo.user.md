TOC:
<!-- TOC -->

- [Генерация ключа](#%D0%B3%D0%B5%D0%BD%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D0%BA%D0%BB%D1%8E%D1%87%D0%B0)
    - [linux](#linux)
    - [windows 10](#windows-10)
        - [Процедура генерации ключа:](#%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D0%B4%D1%83%D1%80%D0%B0-%D0%B3%D0%B5%D0%BD%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8-%D0%BA%D0%BB%D1%8E%D1%87%D0%B0)
        - [Процедура переноса ключа:](#%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D0%B4%D1%83%D1%80%D0%B0-%D0%BF%D0%B5%D1%80%D0%B5%D0%BD%D0%BE%D1%81%D0%B0-%D0%BA%D0%BB%D1%8E%D1%87%D0%B0)
    - [android](#android)
    - [apple](#apple)
- [Создание подключения](#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D1%8F)
    - [linux](#linux)
    - [windows 10](#windows-10)
    - [android](#android)
    - [apple](#apple)

<!-- /TOC -->

# Генерация ключа

    Способы генерации пользователем приватного ключа и запроса для разных операционных систем:

## linux

    Генерация выполняется с использованием openssl. С шифрованием закрытого ключа:

```bash
openssl req -newkey ec:<(openssl genpkey -genparam -algorithm ec -pkeyopt ec_paramgen_curve:P-384) -sha512 -keyout private.key -out mycsr.csr
```

или без шифрования:

```bash
openssl req -newkey ec:<(openssl genpkey -genparam -algorithm ec -pkeyopt ec_paramgen_curve:P-384) -nodes -sha512 -keyout private.key -out mycsr.csr
```

    В процессе выполнения будут заданы вопросы параметрах запроса. В ajalo значение имеет только поле CN (Common name), остальные можно указать произвольно. Поле CN не должно содержать спецсимволов.

В результате получются файл закрытого ключа

```bash
private.key
mycsr.csr
```

    Файл запроса следует отправить администратору для подписания. Когда администратор вернет файл сертификата, его следует использовать вместе с файлом закрытого ключа для создания подключения.

## windows 10

    Для проекта ajalo предлагается выполнять генерацию ключа с помощью графической утилиты [cert_helper_win-0.2.zip](https://tegho.github.io/small_office_vpn/apt-repo/cert_helper_win-0.2.zip) Необходимо распаковать архив и запустить `cert_helper.bat`. При первом запуске может сработать windows defender. Необходимо нажать "**Подробнее**" и "**Выполнить в любом случае**"

    Утилита обращается к пользовательскому хранилищу сертификатов для записи ключа, запроса и сертификата клиента, а также к системному хранилищу сертификатов для записи сертификата CA. Обращение к системному хранилищу запросит права администратора по необходимости. Функции утилиты:

- создать ключ и выгрузить запрос в файл (Кнопка Request)

- принять полученный от администратора ответ на запрос (Кнопка Accept)

- импорт пользовательского ключа и сертификата в файл (Кнопка Import)

- экспорт пользовательского ключа и сертификата в файл (Кнопка Export)

### Процедура генерации ключа:

1) Введите имя (CN) в текстовом поле. Имя не должно содержать спецсимволов.

2) Нажмите Request и выберите куда сохранить файл с запросом.

3) Отправьте файл запроса администратору и получите ответ.

4) Нажмите Accept и выберите файл ответа, который прислал администратор.

### Процедура переноса ключа:

1) Нажмите Export и выберите сертификат с ключо, который нужно перенести.

2) Выберите файл куда нужно сохранить контейнер с переносимым ключом.

3) Файл содержит приватный ключ и должен быть защищен, придумайте пароль.

4) Передайте контейнер на целевое устройство.

Функцию экспорта можно задействовать для переноса созданных ключей на другие свои устройства, например android или apple.

## android

    не тестировалось

## apple

    не тестировалось

# Создание подключения

## linux

    Сгенерировать приватный ключ и запрос. Отправить запрос администратору и получить от него сертификат.

    Для подключения openvpn необходимо установить пакет openvpn

```bash
apt-get install openvpn
```

добавить в конфиг, полученный от администратора, параметры key и cert с указанием файла закрытого ключа и сертификата соответственно. Конфиг следует скопировать в `/etc/openvpn/client` и выполнить подключение командой

```bash
systemctl restart openvpn-client@NAME
```

где NAME это имя файла конфига без расширения `.conf`.

    Для подключения по IPSEC необходимо установить strongswan

```bash
apt-get install strongswan-swanctl
```

и следовать инструкции по выбранному пакету. Сервер подключения `nevada.ajalo.com`, аутентификация `eap-tls`.

## windows 10

    Используя утилиту [cert_helper_win-0.2.zip](https://tegho.github.io/small_office_vpn/apt-repo/cert_helper_win-0.2.zip) сгенерировать приватный ключ и запрос. Отправить запрос администратору, получить от него файл ответа и загрузить его утилитой.

    Для подключения openvpn скачать [openvpn](https://openvpn.net/community-downloads/) и при установке выбрать дополнительно OpenVpn GUI для управления подключениями из systray. Правой кнопкой нажать на OpenVpn GUI в systray, выбрать "импорт", "импорт файла конфигурации" и указать файл конфига, полученный от администратора.

    Для подключения IPSEC открыть управление подключениями VPN, нажать "Добавить VPN-подключение" и задать

- поставщик услуг: Windows

- имя подключения: Ajalo VPN

- имя или адрес сервера: nevada.ajalo.com

- тип VPN: автоматически

- тип данных для входа: сертификат

## android

    Перед началом работы необходимо установить на устройство закрытый ключ и сертификат. Для генерации ключа и получения сертификата можно воспользоваться компьютером windows.

    Для подключения openvpn рекомендуется установить https://play.google.com/store/apps/details?id=org.strongswan.android и добавить конфиг, полученный от администратора.

    Для подключения по IPSEC рекомендуется установить https://play.google.com/store/apps/details?id=net.openvpn.openvpn и добавить новое подключение со следующими параметрами:

- Сервер: nevada.ajalo.com

- VPN тип: IKEv2 EAP-TLS (Сертификат)

- Сертификат пользователя: **(выбрать сертификат)**

- Сертификат CA: выбрать автоматически

## apple

не тестировалось
