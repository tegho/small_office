# Руководство разработчика deb репозитория

    Это руководство регламентирует структуру рабочего стола разработчика deb пакетов и не дублирует документацию на используемые утилиты. Предполагается что разработчик имеет опыт создания и компиляции deb пакетов, знаком с утилитами `devscripts` и другими.

    Для разработки deb репозитория и пакетов потребуется установить набор утилит:

```bash
apt install git devscripts build-essential lintian apt-utils gpgconf gpg gzip xz-utils bzip2
```

    Затем клонировать git:

```bash
git clone https://github.com/tegho/small_office_vpn.git
```

    Файл `/vars` содержит содержит переменные в формате bash скрипта. Переменная `secret_dir="keys"` указывает, что ключи подписи deb репозитория лежат в папке `/keys`, а переменная `repo_webroot="apt-repo"` указывает на каталог `/apt-repo`, куда будет скопирована структура deb репозитория после пересборки. Готовый репозиторий должен быть доступен по web и в текущей реализации каталог `/apt-repo` публикуется через github-pages.

    В каталоге `/keys` лежат открытый и закрытый ключи для подписания deb репозитория после его пересборки. Ключи можно пересоздать интерактивным скриптом `/keys/apt-repo/regen.sh`. В первый раз после клонирования git репозитория следует запустить этот скрипт для генерации ключевой пары.

    После генерации новой ключевой пары необходимо пересобрать пакет `/packages/my-repo`, поскольку он предназначен для установки deb репозитория и должен содержать актуальный открытый ключ.

    Для инсталляция deb репозитория на целевую машину следует выполнять:

```bash
wget -nc http://tegho.github.io/small_office_vpn/apt-repo/pool/main/my-repo_0.1-1_all.deb
dpkg -i ./my-repo_0.1-1_all.deb
apt update
```

>     При повторном размещении клона git репозитория на общедоступных ресурсах следует следить за сохранностью закрытых ключей в каталоге `/keys`

    Процесс пересборки deb репозитория выполняется утилитой `/utils/rebuild-repo.sh` и должен запускаться каждый раз, когда в какой-либо пакет внесено изменение. При этом в каталоге публикации `/apt-repo` создается файловая сруктура deb репозитория, копируются скомпилированные пакеты из каталога `/packages` и выполняется подписание репозитория ключами `/keys`.  После этого следует выполнять публикацию `/apt-repo` на веб-сервере.

    Каталог `/packages` содержит скомпилированные deb пакеты и их исходные файлы в подкаталогах. Исходные файлы deb пакетов находятся в подкаталогах под своими названиями. Каждый пакет после компиляции должен размещаться в каталоге `/packages`.

    Исходные файлы deb пакета собраны в каталогах

```bash
.conf/
debian/
files/
```

    Каталог `files` содержит файловую структуру, которая будет включена в состав пакета. Содержимое этого каталога копируются в корневую файловую систему при установке пакета на целевую машину. Следует обращать внимание на символические ссылки, поскольку при компиляции процедура их обработки может отличаться от процедуры работы с регулярными файлами и папками. Также следует обратить внимание на права на эти файлы. Более подробная информацию следует искать в описании утилиты `debuild` и других утилит пакета `devscripts`. Каталог `files` интегрирован в компиляцию упоминанием в `debian/install`.

    Каталог `debian` знаком разработчику deb пакетов. Обычно он создается утилитой `dh_make` при созданиии нового пакета и используется при компиляции пакета утилитой `debuild`. При использовании инструментов, предлагаемых этим руководством, ручного вмешательства туда не предполагается.

    Каталог `.conf` содержит инструменты, облегчающие автоматизацию процесса создания и сборки пакета, например скрипты для инициализации и пересборки новой версии, скрипты `postinst`,`postrm` ,`prerm` и др. Скрипты имеют нумерацию в названии как рекомендацию по очередности исполнения, а также выводят на экран подсказки о дальнейших шагах. В работе используются файлы `vars` , `version` и `doc.txt`, где указаны общие данные, такие как   короткое и длинное описание пакета, версия и зависимости от других пакетов. Разработчику следует отредактировать каждый из этих скриптов индивидуально под каждый пакет. Неизменным должен быть результат работы - размещение очередной версии скомпилированного deb пакета в каталоге `/packages`.

    `1.init.sh` следует выполнять только при создании нового пакета. При запуске создается каталог `debian`, удаляются скомпилированные версии этого пакета из `/packages`, если обнаружены.

    `2.change-files.sh` наполняет полезными данными каталог `files`. Если автоматизации не требуется и файлы собраны вручную, то скрипт выполнять не обязательно.

    `3.next-revision.sh` следует запускать при внесении изменений в пакет для создания очередной ревизии. Скрипт выводит на экран changelog для внесения туда информации об изменениях, а также увеличивает на 1 номер ревизии пакета.

    `3.next-version.sh` следует запускать при внесении изменений в пакет для создания очередной версии. Скрипт выводит на экран changelog для внесения туда информации об изменениях, и устанавливает номер ревизии 1. Новый номер версии пакета нужно установить редактированием файла `version` перед запуском.

    `3.release.sh` запускается когда текущую версию или ревизию нужно уотметить как релиз. Выполнять не оябзательно.

    `4.build.sh` следует выполнять последним для компиляции пакета. Скрипт заполняет информацию о зависимостях пакета из `vars`, копирует скрипты `postinst`,`postrm` ,`prerm` и др, после чего запускает `debuild`.

    При добавлении нового пакета целесообразно скопировать любой имеющийся пакет, очистить содержимое каталога `files`, а затем отредактировать скрипты и файлы данных в каталоге `.conf` под собственные нужды.
